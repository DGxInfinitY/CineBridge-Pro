name: Build CineBridge Pro

on:
  push:
    tags:
      - 'v*'  # Trigger only when a version tag (e.g. v4.7.2) is pushed

permissions:
  contents: write

jobs:
  # =========================================================
  # 1. WINDOWS BUILD
  # =========================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg (Windows)
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          $ffmpeg = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          $ffprobe = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffprobe.exe" | Select-Object -First 1
          if ($ffmpeg -and $ffprobe) {
              Move-Item -Path $ffmpeg.FullName -Destination "." -Force
              Move-Item -Path $ffprobe.FullName -Destination "." -Force
          } else {
              Write-Error "‚ùå FFmpeg not found!"
              exit 1
          }

      - name: Create Icon (.ico)
        run: |
          magick convert -background none "assets/icon.svg" -define icon:auto-resize="256,128,64,48,32,16" "assets/icon.ico"

      # NEW: Sync Version Number (Uses Bash on Windows)
      - name: Sync Version Number
        shell: bash
        run: |
          # Sync Python code version
          sed -i "s/CineBridge Pro v[0-9.]*/CineBridge Pro ${{ github.ref_name }}/g" src/cinebridge.py
          
          # Extract version components
          VERSION_RAW=$(echo "${{ github.ref_name }}" | sed 's/v//g')
          # Ensure 4-part version for Windows metadata (e.g. 4.15.0.0)
          VERSION_4PART=$(echo "$VERSION_RAW.0.0.0" | cut -d. -f1-4)
          VERSION_COMMA=$(echo "$VERSION_4PART" | sed 's/\./, /g')
          
          # Sync windows_version_info.txt strings and tuples
          sed -i "s/4.16.0.0/$VERSION_4PART/g" windows_version_info.txt
          sed -i "s/4, 16, 0, 0/$VERSION_COMMA/g" windows_version_info.txt
          
          # Sync setup_script.iss (replaces whatever version is currently there)
          sed -i "s/AppVersion=[0-9.]*/AppVersion=$VERSION_RAW/g" setup_script.iss

      - name: Build with PyInstaller
        run: |
          pyinstaller src/cinebridge.py --noconsole --onefile --name "CineBridgePro" --icon "assets/icon.ico" --version-file "windows_version_info.txt" --add-data "assets;assets" --add-binary "ffmpeg.exe;." --add-binary "ffprobe.exe;."

      - name: Compile Setup Installer (Inno Setup)
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss

      - name: Upload Artifact
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/CineBridgePro.exe
            dist/CineBridgePro_Windows_Setup.exe

  # =========================================================
  # 2. MACOS BUILD
  # =========================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          brew install imagemagick
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Download FFmpeg (Mac)
        run: |
          curl -L -o ffmpeg.zip https://evermeet.cx/ffmpeg/ffmpeg-6.0.zip
          curl -L -o ffprobe.zip https://evermeet.cx/ffmpeg/ffprobe-6.0.zip
          unzip ffmpeg.zip
          unzip ffprobe.zip
          chmod +x ffmpeg ffprobe

      - name: Create Icon (.icns)
        run: |
          mkdir CineBridgePro.iconset
          convert -background none -resize 1024x1024 assets/icon.svg master_icon.png
          sips -z 16 16     master_icon.png --out CineBridgePro.iconset/icon_16x16.png
          sips -z 32 32     master_icon.png --out CineBridgePro.iconset/icon_16x16@2x.png
          sips -z 32 32     master_icon.png --out CineBridgePro.iconset/icon_32x32.png
          sips -z 64 64     master_icon.png --out CineBridgePro.iconset/icon_32x32@2x.png
          sips -z 128 128   master_icon.png --out CineBridgePro.iconset/icon_128x128.png
          sips -z 256 256   master_icon.png --out CineBridgePro.iconset/icon_128x128@2x.png
          sips -z 256 256   master_icon.png --out CineBridgePro.iconset/icon_256x256.png
          sips -z 512 512   master_icon.png --out CineBridgePro.iconset/icon_256x256@2x.png
          sips -z 512 512   master_icon.png --out CineBridgePro.iconset/icon_512x512.png
          sips -z 1024 1024 master_icon.png --out CineBridgePro.iconset/icon_512x512@2x.png
          iconutil -c icns CineBridgePro.iconset
          mv CineBridgePro.icns assets/icon.icns

      # NEW: Sync Version Number
      - name: Sync Version Number
        run: |
          sed -i '' "s/CineBridge Pro v[0-9.]*/CineBridge Pro ${{ github.ref_name }}/g" src/cinebridge.py

      - name: Build with PyInstaller
        run: |
          pyinstaller src/cinebridge.py --noconsole --onefile --windowed --name "CineBridgePro" --icon "assets/icon.icns" --add-data "assets:assets" --add-binary "ffmpeg:." --add-binary "ffprobe:."

      - name: Zip Application
        run: |
          cd dist
          zip -r CineBridgePro_macOS.zip CineBridgePro.app

      - name: Upload Artifact
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/CineBridgePro_macOS.zip

  # =========================================================
  # 3. LINUX BUILD
  # =========================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install System Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip imagemagick

      - name: Install Python Deps
        run: |
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Create Icon (.png)
        run: |
          convert -background none -resize 512x512 assets/icon.svg assets/icon.png

      # NEW: Sync Version Number
      - name: Sync Version Number
        run: |
          sed -i "s/CineBridge Pro v[0-9.]*/CineBridge Pro ${{ github.ref_name }}/g" src/cinebridge.py

      - name: Build Binary
        run: |
          pyinstaller src/cinebridge.py --noconsole --onefile --name "cinebridgepro" --icon "assets/icon.png" --add-data "assets:assets"

      - name: Prepare Artifacts
        run: |
          mkdir -p dist/deb/usr/local/bin
          mkdir -p dist/deb/usr/share/applications
          mkdir -p dist/deb/usr/share/icons/hicolor/512x512/apps
          mkdir -p dist/deb/DEBIAN

          cp dist/cinebridgepro dist/deb/usr/local/bin/
          cp assets/icon.png dist/deb/usr/share/icons/hicolor/512x512/apps/cinebridgepro.png
          chmod 755 dist/deb/usr/local/bin/cinebridgepro

          # Prepare Portable Binary
          mv dist/cinebridgepro dist/CineBridgePro_Linux_Portable
          chmod +x dist/CineBridgePro_Linux_Portable

          cat <<EOF > dist/deb/usr/share/applications/cinebridgepro.desktop
          [Desktop Entry]
          Name=CineBridge Pro
          Comment=DIT and Transcoding Suite
          Exec=/usr/local/bin/cinebridgepro
          Icon=cinebridgepro
          Terminal=false
          Type=Application
          Categories=Video;AudioVideo;
          EOF

          cat <<EOF > dist/deb/DEBIAN/control
          Package: cinebridgepro
          Version: ${{ github.ref_name }}
          Section: video
          Priority: optional
          Architecture: amd64
          Depends: ffmpeg, python3
          Maintainer: Donovan Goodwin <ddg2goodwin@gmail.com>
          Description: Open Source DIT & Post-Production Suite
           CineBridge Pro automates video ingest, proxy generation, and delivery.
          EOF
          
          sed -i 's/Version: v/Version: /g' dist/deb/DEBIAN/control

      - name: Build DEB
        run: |
          dpkg-deb --build dist/deb cinebridgepro_linux_amd64.deb

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            cinebridgepro_linux_amd64.deb
            dist/CineBridgePro_Linux_Portable
